<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Learning Formats Experiment</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    #content, #reentry, #invalid, #reason, #countdown { margin-top: 20px; }
    .hidden { display: none; }
    .unselectable { user-select: none; }
    .container { max-width: 760px; margin: 0 auto; text-align: left; }
    #tokenDisplay { font-weight: bold; font-size: 1.5em; letter-spacing: 0.08em; }
  </style>
</head>
<body>
  <h1>Learning Formats Experiment</h1>

  <!-- Countdown -->
  <div id="countdown">Time left: 05:00</div>

  <!-- Main content -->
  <div id="content"></div>

  <!-- Re-entry UI -->
  <div id="reentry" class="hidden">
    <p id="reason" class="container"></p>
    <p>Here’s your re‑entry token (send this to Nyoman):</p>
    <p id="tokenDisplay"></p>
    <p>After Nyoman replies with a hash, paste it below to regain access:</p>
    <input type="text" id="hashInput" placeholder="Paste SHA‑256 hash here">
    <button onclick="checkHash()">Re‑enter</button>
  </div>

  <!-- Invalid hash -->
  <div id="invalid" class="hidden">
    <p style="color:red;">Invalid hash. Please request a new one.</p>
  </div>

  <script>
    const TEXT_UUID  = "019be56a-abf7-7c8c-9dee-d3f8d096e502";
    const VIDEO_UUID = "019be56f-ac80-7f1c-81e8-e01c03826d35";

    const params = new URLSearchParams(window.location.search);
    const key = params.get("key");

    const contentEl   = document.getElementById("content");
    const reentryEl   = document.getElementById("reentry");
    const invalidEl   = document.getElementById("invalid");
    const tokenDisplay= document.getElementById("tokenDisplay");
    const reasonEl    = document.getElementById("reason");
    const countdownEl = document.getElementById("countdown");

    let expectedHash = null;
    let mode = null;
    let timer;

    // --- Persistence keys ---
    const REENTRY_FLAG_KEY   = "reentryNeeded";
    const REENTRY_REASON_KEY = "reentryReason";
    const MODE_KEY           = "assignedMode";
    const SESSION_START_KEY  = "sessionStartTs";

    // --- Restore state on load ---
    if (localStorage.getItem(REENTRY_FLAG_KEY) === "1") {
      mode = localStorage.getItem(MODE_KEY);
      if (mode === null) {
        mode = "text";
        localStorage.setItem(MODE_KEY, "text");
      } else if (mode === null) {
        mode = "video";
        localStorage.setItem(MODE_KEY, "video");
      }
      triggerReentry(localStorage.getItem(REENTRY_REASON_KEY));
    } else {
      if (key === TEXT_UUID) {
        mode = "text";
        localStorage.setItem(MODE_KEY, "text");
        showText();
      } else if (key === VIDEO_UUID) {
        mode = "video";
        localStorage.setItem(MODE_KEY, "video");
        showVideo();
      } else {
        mode = localStorage.getItem(MODE_KEY) || "text";
        triggerReentry("no valid key provided");
      }
    }

    function showText() {
      contentEl.classList.remove("hidden");
      reentryEl.classList.add("hidden");
      invalidEl.classList.add("hidden");
      contentEl.innerHTML = `<div class="unselectable container">
      <p>
        The journey of computers began in the 1800s with mechanical devices, but the modern era started in the 1930s when Konrad Zuse built the Z1, the first programmable computer. His later model, the Z3, became the world’s first digital computer. After Z3's destruction in World War II, Zuse introduced the Z4 in 1950, marking the first commercial digital computer.
      </p><br><p>
        In 1941, J.V. Atanasoff and Clifford Berry developed a machine that could store data in memory. During the war, massive machines like Colossus and ENIAC were built to decode Nazi cryptic messages and perform military calculations. ENIAC alone used 18,000 vacuum tubes and filled an entire room.
      </p><br><p>
        The 1950s saw the introduction of transistors, which replaced vacuum tubes, making computers faster and smaller. Grace Hopper created COBOL, one of the first programming languages, and IBM launched its first computers. In the 1960s, IBM’s 7000 series introduced transistor-based mainframes, but it was the IBM 360 series that became a major industry standard. Its modular design allowed businesses to scale computing power, making it one of the most influential systems of its time.
      </p><br><p>
        In 1965, the Programma 101 became the first desktop computer sold to the public. The 1970s brought Intel’s DRAM chip and IBM’s floppy disk. The Altair 8800, launched in 1975, was a kit-based computer that helped popularize the term “personal computer.” It ran BASIC, a programming language developed by Bill Gates and Paul Allen, and inspired a wave of hobbyist computing.
      </p><br><p>
        Apple entered the scene in 1976 with the Apple I, followed by the successful Apple II. IBM’s PC in 1981, running MS-DOS, revolutionized the market. Apple’s Lisa and Macintosh introduced graphical interfaces and the mouse in the early 1980s.
      </p><br><p>
        By the 1990s, computers became more user-friendly and internet-connected. Apple’s colorful iMacs and the powerful G5 in 2003 pushed design and performance forward. Today, compact systems like the Mac Mini offer high power in small form factors, proof that computer technology continues to evolve rapidly.
      </p></div>`;
      startCountdown();
    }

    function showVideo() {
      contentEl.classList.remove("hidden");
      reentryEl.classList.add("hidden");
      invalidEl.classList.add("hidden");
      contentEl.innerHTML = `<iframe width="560" height="315"
        src="https://www.youtube.com/embed/gjVX47dLlN8?controls=0&modestbranding=1&rel=0&disablekb=1"
        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      startCountdown();
    }

    async function generateToken() {
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      let token = "";
      for (let i = 0; i < 4; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      tokenDisplay.textContent = token;

      const hashBuffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(token));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      expectedHash = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function triggerReentry(reason) {
      contentEl.classList.add("hidden");
      countdownEl.classList.add("hidden");
      reentryEl.classList.remove("hidden");
      reasonEl.textContent = "Re-entry required due to: " + reason;
      generateToken();
      clearInterval(timer);
      localStorage.setItem(REENTRY_FLAG_KEY, "1");
      localStorage.setItem(REENTRY_REASON_KEY, reason);
    }

    function clearReentry() {
      localStorage.removeItem(REENTRY_FLAG_KEY);
      localStorage.removeItem(REENTRY_REASON_KEY);
    }

    function checkHash() {
      const entered = document.getElementById("hashInput").value.trim().toLowerCase();
      if (entered === expectedHash) {
        clearReentry();
        reentryEl.classList.add("hidden");
        invalidEl.classList.add("hidden");
        if (mode === "text") showText();
        else showVideo();
      } else {
        invalidEl.classList.remove("hidden");
      }
    }

    function startCountdown() {
      // Persist session start if not set
      if (!localStorage.getItem(SESSION_START_KEY)) {
        localStorage.setItem(SESSION_START_KEY, Date.now());
      }
      updateCountdown();
      timer = setInterval(() => {
        updateCountdown();
      }, 1000);
    }

    function updateCountdown() {
      const start = Number(localStorage.getItem(SESSION_START_KEY));
      const elapsed = Math.floor((Date.now() - start) / 1000);
      let limit = (mode === "video") ? 440 : 300; // 6m51s for video, 5m for text
      let remaining = limit - elapsed;
      if (remaining <= 0) {
        triggerReentry("session exceeded time limit");
        return;
      }
      let minutes = Math.floor(remaining / 60);
      let seconds = remaining % 60;
      countdownEl.textContent = `Time left: ${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    // Focus loss trigger
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) triggerReentry("tab switch / lost focus");
    });

    // Resize trigger
    let initialWidth = window.innerWidth;
    let initialHeight = window.innerHeight;
    window.addEventListener("resize", () => {
      const wDiff = Math.abs(window.innerWidth - initialWidth);
      const hDiff = Math.abs(window.innerHeight - initialHeight);
      if (wDiff > 200 || hDiff > 200) {
        triggerReentry("window resize / resolution change");
      }
    });
  </script>
</body>
</html>
