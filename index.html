<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Learning Formats Experiment</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    #content, #reentry, #invalid, #reason, #countdown { margin-top: 20px; }
    .hidden { display: none; }
    .unselectable { user-select: none; }
    .container { max-width: 760px; margin: 0 auto; text-align: left; }
    #tokenDisplay { font-weight: bold; font-size: 1.5em; letter-spacing: 0.08em; }
  </style>
</head>
<body>
  <h1>Learning Formats Experiment</h1>

  <!-- Countdown -->
  <div id="countdown">Time left: 05:00</div>

  <!-- Main content -->
  <div id="content"></div>

  <!-- Re-entry UI -->
  <div id="reentry" class="hidden">
    <p id="reason" class="container"></p>
    <p>Here’s your re‑entry token (send this to Nyoman):</p>
    <p id="tokenDisplay"></p>
    <p>After Nyoman replies with a hash, paste it below to regain access:</p>
    <input type="text" id="hashInput" placeholder="Paste SHA‑256 hash here">
    <button onclick="checkHash()">Re‑enter</button>
  </div>

  <!-- Invalid hash -->
  <div id="invalid" class="hidden">
    <p style="color:red;">Invalid hash. Please request a new one.</p>
  </div>

  <script>
    const TEXT_UUID  = "019be56a-abf7-7c8c-9dee-d3f8d096e502";
    const VIDEO_UUID = "019be56f-ac80-7f1c-81e8-e01c03826d35";

    const params = new URLSearchParams(window.location.search);
    const key = params.get("key");

    const contentEl   = document.getElementById("content");
    const reentryEl   = document.getElementById("reentry");
    const invalidEl   = document.getElementById("invalid");
    const tokenDisplay= document.getElementById("tokenDisplay");
    const reasonEl    = document.getElementById("reason");
    const countdownEl = document.getElementById("countdown");

    let expectedHash = null;
    let mode = null;
    let timer;

    // --- Persistence keys ---
    const REENTRY_FLAG_KEY   = "reentryNeeded";
    const REENTRY_REASON_KEY = "reentryReason";
    const MODE_KEY           = "assignedMode";
    const SESSION_START_KEY  = "sessionStartTs";

    // --- Restore state on load ---
    if (localStorage.getItem(REENTRY_FLAG_KEY) === "1") {
      mode = localStorage.getItem(MODE_KEY) || "text";
      triggerReentry(localStorage.getItem(REENTRY_REASON_KEY));
    } else {
      if (key === TEXT_UUID) {
        mode = "text";
        localStorage.setItem(MODE_KEY, "text");
        showText();
      } else if (key === VIDEO_UUID) {
        mode = "video";
        localStorage.setItem(MODE_KEY, "video");
        showVideo();
      } else {
        mode = localStorage.getItem(MODE_KEY) || "text";
        triggerReentry("no valid key provided");
      }
    }

    function showText() {
      contentEl.classList.remove("hidden");
      reentryEl.classList.add("hidden");
      invalidEl.classList.add("hidden");
      contentEl.innerHTML = `<div class="unselectable container"><p>...full passage here...</p></div>`;
      startCountdown();
    }

    function showVideo() {
      contentEl.classList.remove("hidden");
      reentryEl.classList.add("hidden");
      invalidEl.classList.add("hidden");
      contentEl.innerHTML = `<iframe width="560" height="315"
        src="https://www.youtube.com/embed/gjVX47dLlN8?controls=0&modestbranding=1&rel=0&disablekb=1"
        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      startCountdown();
    }

    async function generateToken() {
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      let token = "";
      for (let i = 0; i < 4; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      tokenDisplay.textContent = token;

      const hashBuffer = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(token));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      expectedHash = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function triggerReentry(reason) {
      contentEl.classList.add("hidden");
      countdownEl.classList.add("hidden");
      reentryEl.classList.remove("hidden");
      reasonEl.textContent = "Re‑entry required due to: " + reason;
      generateToken();
      clearInterval(timer);
      localStorage.setItem(REENTRY_FLAG_KEY, "1");
      localStorage.setItem(REENTRY_REASON_KEY, reason);
    }

    function clearReentry() {
      localStorage.removeItem(REENTRY_FLAG_KEY);
      localStorage.removeItem(REENTRY_REASON_KEY);
    }

    function checkHash() {
      const entered = document.getElementById("hashInput").value.trim().toLowerCase();
      if (entered === expectedHash) {
        clearReentry();
        reentryEl.classList.add("hidden");
        invalidEl.classList.add("hidden");
        if (mode === "text") showText();
        else showVideo();
      } else {
        invalidEl.classList.remove("hidden");
      }
    }

    function startCountdown() {
      // Persist session start if not set
      if (!localStorage.getItem(SESSION_START_KEY)) {
        localStorage.setItem(SESSION_START_KEY, Date.now());
      }
      updateCountdown();
      timer = setInterval(() => {
        updateCountdown();
      }, 1000);
    }

    function updateCountdown() {
      const start = Number(localStorage.getItem(SESSION_START_KEY));
      const elapsed = Math.floor((Date.now() - start) / 1000);
      let limit = (mode === "video") ? 411 : 300; // 6m51s for video, 5m for text
      let remaining = limit - elapsed;
      if (remaining <= 0) {
        triggerReentry("session exceeded time limit");
        return;
      }
      let minutes = Math.floor(remaining / 60);
      let seconds = remaining % 60;
      countdownEl.textContent = `Time left: ${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    // Focus loss trigger
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) triggerReentry("tab switch / lost focus");
    });

    // Resize trigger
    let initialWidth = window.innerWidth;
    let initialHeight = window.innerHeight;
    window.addEventListener("resize", () => {
      const wDiff = Math.abs(window.innerWidth - initialWidth);
      const hDiff = Math.abs(window.innerHeight - initialHeight);
      if (wDiff > 200 || hDiff > 200) {
        triggerReentry("window resize / resolution change");
      }
    });
  </script>
</body>
</html>
